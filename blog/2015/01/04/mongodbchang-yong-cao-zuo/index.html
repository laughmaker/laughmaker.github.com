
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>mongodb常用操作 - 闻竹</title>
  <meta name="author" content="makeLaugh">

  
  <meta name="description" content="PHP对MongoDB的扩展文档地址：http://us3.php.net/manual/en/book.mongo.php 在PHP的Mongo扩展中，有4类接口对象： 1.针对MongoDB的连接的操作：MongoClient
http://us3.php.net/manual/en/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://makeLaugh.github.io/blog/2015/01/04/mongodbchang-yong-cao-zuo">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="闻竹" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'> -->
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">闻竹</a></h1>
  
    <h2>于车马喧哗中守一份宁静      于万马齐喑中持一片热忱</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:makeLaugh.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">主页</a></li>
  <li><a href="/blog/archives">文章归档</a></li>
  <li><a href="/about">关于我</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Mongodb常用操作</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-04T15:56:30+08:00" pubdate data-updated="true">Jan 4<span>th</span>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><hr />

<p>PHP对MongoDB的扩展文档地址：http://us3.php.net/manual/en/book.mongo.php</p>

<pre><code>在PHP的Mongo扩展中，有4类接口对象：  
1.针对MongoDB的连接的操作：MongoClient
http://us3.php.net/manual/en/class.mongoclient.php
2.针对MongoDB中数据库的操作：MongoDB
http://us3.php.net/manual/en/book.mongo.php
3.针对MongoDB中的Collection的操作：MongoCollection
http://us3.php.net/manual/en/class.mongocollection.php
4.针对查询结果集的操作：MongoCursor和MongoCommandCursor
http://us3.php.net/manual/en/class.mongocursor.php
http://us3.php.net/manual/en/class.mongocommandcursor.php
</code></pre>

<hr />

<h4 id="section">常用管理命令</h4>
<pre><code>./mongo	#启动Mongo Shell
use foo	#进入数据库foo
db.createUser({user:'hzdRW', pwd:'hezhendong', roles:[{role:'dbOwner', db:'hzdDB'}]} #添加用户或修改用户密码
db.system.users.find()	#查看用户列表
db.auth('name', 'pwd')	#用户认证
db.removeUser('name')	#删除用户
show users	#查看所有用户
show dbs	#查看所有数据库
show collectios  #查看所有的collection
db.printCollectionStats()	#查看各collection的状态
db.printReplicationInfo()	#查看主从复制状态
db.repariDatabase()	 #修复数据库
db.copyDatabase(fromDB, toDB, fromHost[, username, password])  #拷贝数据库
db.collection_name.drop()  #删除集合
db.dropDatabase()  #删除当前数据库
db.shutdownServer() #关闭当前服务程序
exit #退出当前shel
</code></pre>

<hr />

<h4 id="section-1">数据库连接</h4>
<p>1.默认连接本机的27017端口 </p>

<pre><code>$mongo = new MongoClient();
</code></pre>

<p>2.自定义格式连接，一般ip为本机可写为localhost,port可省略  </p>

<pre><code>格式：$mongo = new MongoClient('mongodb://username:password@ip:port');  
</code></pre>

<hr />

<h4 id="section-2">查询</h4>
<p>1.find findOne findAndModify</p>

<ul>
  <li>
    <p>查询user集合中全部内容：</p>

    <pre><code>  db.user.find();
</code></pre>
  </li>
  <li>
    <p>查询user集合中age的值为27的文档：</p>

    <pre><code>  db.user.find({"age":27});
</code></pre>
  </li>
  <li>
    <p>查询user集合中age为27,username为joe的内容：</p>

    <pre><code>  db.user.find({"age":27, "username":27});
</code></pre>
  </li>
  <li>
    <p>查询user集合中的所有内容，但只返回username和email键的值：</p>

    <pre><code>  db.user.find({}, {"username":1, "email":1});
</code></pre>
  </li>
  <li>
    <p>查询user集合中的所有内容，但剔除age键：</p>

    <pre><code>  db.user.find({}, {"age": 0});
</code></pre>
  </li>
  <li>
    <p>查询user集合中的age为18的第一条记录：</p>

    <pre><code>  db.user.findOne({"age":18});
</code></pre>
  </li>
  <li>
    <p>根据查询条件找到相应的记录并对一条结果做更新操作，其中query为查询条件，sort指定排序，remove表示删除（remove和update不能同时指定），new表示返回更新之前还是之后的结果，这条命令只能返回一条结果</p>

    <pre><code>  db.user.findAndModify({"query":{"username":"joe"}, "sort":{"age":1}, "remove":true, "new":true});
</code></pre>
  </li>
</ul>

<p>2.查询操作符</p>

<pre><code>$lt(&lt;) $lte(&lt;=) $gt(&gt;=) $gte(&gt;=) 
$in(匹配一个键的多个值) $nin(与列出来的所有值都不匹配)
$all:匹配数组中所有元素，模糊匹配，不关注顺序
$not:反向匹配
$size:匹配数组长度
</code></pre>

<ul>
  <li>
    <p>查询age在18～30(含)岁之间的用户：</p>

    <pre><code>  db.user.find({"age":{"$gte":18, "$lte":30}});
</code></pre>
  </li>
  <li>
    <p>查询age为18、20、22岁的用户：</p>

    <pre><code>  db.user.find({"age":{"$in":[18, 20, 22]}});
</code></pre>
  </li>
  <li>
    <p>查询age不为18、20、22岁的所有用户：</p>

    <pre><code>  db.user.find({"age":{"$nin":[18, 20, 22]}});
</code></pre>
  </li>
  <li>
    <p>查询username不为joe的所有用户：</p>

    <pre><code>  db.user.find({"username":{"$not":"joe"}});
</code></pre>
  </li>
</ul>

<p>3.$exists<br />
判断字段是否存在</p>

<ul>
  <li>
    <p>查询所有存在username字段的记录：</p>

    <pre><code>  db.user.find({"username":{"$exsits":true}});
</code></pre>
  </li>
  <li>
    <p>查询所有不存在username字段的记录：</p>

    <pre><code>  db.user.find({"username":{"$exsits":false}});
</code></pre>
  </li>
</ul>

<p>4.$slice<br />
返回数组的一个子集合</p>

<ul>
  <li>
    <p>查询user集合中username为joe的前10个用户：</p>

    <pre><code>  db.user.find({"username":"joe"}, {"$slice": 10});
</code></pre>
  </li>
  <li>
    <p>查询user集合中从第21条记录开始的10条记录：</p>

    <pre><code>  db.user.find({"username":"joe"}, {"$slice":[20, 10]});
</code></pre>
  </li>
</ul>

<p>5.对结果排序  </p>

<ul>
  <li>对年龄升序：db.user.find().sort({“age”:1});</li>
  <li>对年龄降序：db.user.find().sort({“age”:-1});</li>
</ul>

<p>6.限制返回数据条数  </p>

<ul>
  <li>返回5条记录:db.user.find().limit(5)</li>
  <li>从第3条记录开始，返回5条记录:db.user.find().skip(3).limit(5)</li>
  <li>返回记录条数:db.user.find().count()</li>
  <li>返回限制条件后的记录数量:db.user.find().skip(10).limit(5).count(1)</li>
</ul>

<hr />

<h4 id="section-3">插入、更新、删除</h4>
<p><code>insert save update remove</code><br />
若存在_id主键，insert()不做操作，且提示错误，save()改变原来的内容为新内容。</p>

<p><strong>修改器</strong>:</p>

<pre><code>$set:修改字段
$unset:删除字段，不论对目标键使用1、0、-1或者具体的字符串等都是可以删除该目标键。
$rename:修改字段字
$push、pushAll:向数组末尾追加数据，字段不存在则创建
$addToSet:向数组类型乐加数据时避免重复
$each:遍历数组
$pop:从数组中删除数据，{"$pop":{key:1}}从末尾删除，-1从头部删除
$pull和$pullAll:从数组中删除指定数据
</code></pre>

<ul>
  <li>
    <p>向user集合中插入单个文档：</p>

    <pre><code>  db.user.insert({"username":"joe", "age":18});
</code></pre>
  </li>
  <li>
    <p>清空user集合：</p>

    <pre><code>  db.user.remove();
</code></pre>
  </li>
  <li>
    <p>清除user集合中所有age为18的数据：</p>

    <pre><code>  db.user.remove({"age":18});
</code></pre>
  </li>
  <li>
    <p>根据query条件修改，如果不存在则插入，物许修改多条记录：</p>

    <pre><code>  db.foo.update({"y":1}, {"$set":{"x":2}}, upsert=true, multi=true);
</code></pre>
  </li>
  <li>
    <p>找到username为joe的记录，并删除email字段：</p>

    <pre><code>  db.user.update({"username":"joe"}, {"$unset":{"email":1}});
</code></pre>
  </li>
  <li>
    <p>修改username为nickname:</p>

    <pre><code>  db.user.update({}, {"$rename":{"username":"nickname"}});
</code></pre>
  </li>
</ul>

<hr />

<h4 id="section-4">修改器详解示例</h4>

<pre><code>对于文档的更新除替换外，针对某个或多个文档只需要部分更新可使用原子的更新修改器，能够高效的进行文档更新。更新修改器是中特殊的键， 用来指定复杂的操作，比如增加、删除或者调整键，还可能是操作数组或者内嵌文档。
</code></pre>

<p>1.$inc</p>

<p>$inc可以对文档的某个值为数字型（只能为满足要求的数字）的键进行增减的操作。</p>

<pre><code>示例文档：{"uid":"201203","type":"1",size:10}
&gt; db.b.insert({"uid":"201203","type":"1",size:10})
&gt; db.b.find()
{ "_id" : ObjectId("5003b6135af21ff428dafbe6"), "uid" : "201203", "type" : "1",
"size" : 10 }
&gt; db.b.update({"uid" : "201203"},{"$inc":{"size" : 1}})
&gt; db.b.find()
{ "_id" : ObjectId("5003b6135af21ff428dafbe6"), "uid" : "201203", "type" : "1",
"size" : 11 }
&gt; db.b.update({"uid" : "201203"},{"$inc":{"size" : 2}})
&gt; db.b.find()
{ "_id" : ObjectId("5003b6135af21ff428dafbe6"), "uid" : "201203", "type" : "1",
"size" : 13 }
&gt; db.b.update({"uid" : "201203"},{"$inc":{"size" : -1}})
&gt; db.b.find()
{ "_id" : ObjectId("5003b6135af21ff428dafbe6"), "uid" : "201203", "type" : "1",
"size" : 12 }
</code></pre>

<p>2.$set</p>

<p>用来指定一个键并更新键值，若键不存在并创建，对于内嵌文档在使用$set更新时，使用”.”连接的方式。</p>

<pre><code>&gt; db.a.findOne({"uid" : "20120002","type" : "3"})
{ "_id" : ObjectId("500216de81b954b6161a7d8f"), "desc" : "hello world2!", "num"
: 40, "sname" : "jk", "type" : "3", "uid" : "20120002" }
</code></pre>

<p>–size键不存在的场合</p>

<pre><code>&gt; db.a.update({"uid" : "20120002","type" : "3"},{"$set":{"size":10}})
&gt; db.a.findOne({"uid" : "20120002","type" : "3"})
{ "_id" : ObjectId("500216de81b954b6161a7d8f"), "desc" : "hello world2!", "num"
: 40, "size" : 10, "sname" : "jk", "type" : "3", "uid" : "20120002" }
</code></pre>

<p>–sname键存在的场合</p>

<pre><code>&gt; db.a.update({"uid" : "20120002","type" : "3"},{"$set":{"sname":"ssk"}})
&gt; db.a.find()
{ "_id" : ObjectId("500216de81b954b6161a7d8f"), "desc" : "hello world2!", "num"
: 40, "size" : 10, "sname" : "ssk", "type" : "3", "uid" : "20120002" }
{ "_id" : ObjectId("50026affdeb4fa8d154f8572"), "desc" : "hello world1!", "num"
: 50, "sname" : "jk", "type" : "1", "uid" : "20120002" }
</code></pre>

<p>–可改变键的值类型</p>

<pre><code>&gt; db.a.update({"uid" : "20120002","type" : "3"},{"$set":{"sname":["java",".net","c++"]}})
&gt; db.a.findOne({"uid" : "20120002","type" : "3"})
{
        "_id" : ObjectId("500216de81b954b6161a7d8f"),
        "desc" : "hello world2!",
        "num" : 40,
        "size" : 10,
        "sname" : [
                "java",
                ".net",
                "c++"
        ],
        "type" : "3",
        "uid" : "20120002"
}
</code></pre>

<p>对于内嵌的文档，$set又是如何进行更新的内嵌的文档的呢，请看下面的示例：</p>

<pre><code>示例文档：{"name":"toyota","type":"suv","size":{"height":10,"width":5,"length":15}}
&gt; db.c.findOne({"name":"toyota"})
{
        "_id" : ObjectId("5003be465af21ff428dafbe7"),
        "name" : "toyota",
        "type" : "suv",
        "size" : {
                "height" : 10,
                "width" : 5,
                "length" : 15
        }
}
&gt; db.c.update({"name":"toyota"},{"$set":{"size.height":8}})
&gt; db.c.findOne({"name":"toyota"})
{
        "_id" : ObjectId("5003be465af21ff428dafbe7"),
        "name" : "toyota",
        "type" : "suv",
        "size" : {
                "height" : 8,
                "width" : 5,
                "length" : 15
        }
}
&gt; db.c.update({"name":"toyota"},{"$set":{"size.width":7}})
&gt; db.c.findOne({"name":"toyota"})
{
        "_id" : ObjectId("5003be465af21ff428dafbe7"),
        "name" : "toyota",
        "type" : "suv",
        "size" : {
                "height" : 8,
                "width" : 7,
                "length" : 15
        }
}
</code></pre>

<p>3.$unset</p>

<p>从字面就可以看出其意义，主要是用来删除键。
使用修改器$unset时，不论对目标键使用1、0、-1或者具体的字符串等都是可以删除该目标键。</p>

<pre><code>示例操作效果如下：
&gt; db.a.update({"uid" : "20120002","type" : "3"},{"$unset":{"sname":1}})
&gt; db.a.findOne({"uid" : "20120002","type" : "3"})
{
        "_id" : ObjectId("500216de81b954b6161a7d8f"),
        "desc" : "hello world2!",
        "num" : 40,
        "size" : 10,
        "type" : "3",
        "uid" : "20120002"
}
&gt; db.a.update({"uid" : "20120002","type" : "3"},{"$unset":{"num":0}})
&gt; db.a.findOne({"uid" : "20120002","type" : "3"})
{
        "_id" : ObjectId("500216de81b954b6161a7d8f"),
        "desc" : "hello world2!",
        "size" : 10,
        "type" : "3",
        "uid" : "20120002"
}
&gt; db.a.update({"uid" : "20120002","type" : "3"},{"$unset":{"size":-1}})
&gt; db.a.findOne({"uid" : "20120002","type" : "3"})
{
        "_id" : ObjectId("500216de81b954b6161a7d8f"),
        "desc" : "hello world2!",
        "type" : "3",
        "uid" : "20120002"
}
&gt; db.a.update({"uid" : "20120002","type" : "3"},{"$unset":{"desc":"sssssss"}})
&gt; db.a.findOne({"uid" : "20120002","type" : "3"})
{
        "_id" : ObjectId("500216de81b954b6161a7d8f"),
        "type" : "3",
        "uid" : "20120002"
}
</code></pre>

<p>4.数组修改器–$push</p>

<p>$push–向文档的某个数组类型的键添加一个数组元素，不过滤重复的数据。添加时键存在，要求键值类型必须是数组；键不存在，则创建数组类型的键。</p>

<p>示例操作效果如下：</p>

<pre><code>&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "type" : "suv",
"size" : { "height" : 8, "width" : 7, "length" : 15 } }
</code></pre>

<p>先push一个当前文档中不存在的键title</p>

<pre><code>&gt; db.c.update({"name" : "toyota"},{$push:{"title":"t1"}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t1" ], "type" : "suv" }
</code></pre>

<p>再向title中push一个值</p>

<pre><code>&gt; db.c.update({"name" : "toyota"},{$push:{"title":"t2"}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t1", "t2" ], "type" : "suv" }
</code></pre>

<p>再向title中push一个值</p>

<pre><code>&gt; db.c.update({"name" : "toyota"},{$push:{"title":"t2"}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t1", "t2", "t2" ], "type" : "suv" }
</code></pre>

<p>再向一个已经存在的键值非数组类型的键push一个值</p>

<pre><code>&gt; db.c.update({"name" : "toyota"},{$push:{"size.height":10}})
Cannot apply $push/$pushAll modifier to non-array
&gt; db.c.update({"name" : "toyota"},{$push:{"name":"ddddddd"}})
Cannot apply $push/$pushAll modifier to non-array
</code></pre>

<p>5.数组修改器–$ne/$addToSet</p>

<p>主要给数组类型键值添加一个元素时，避免在数组中产生重复数据，$ne在有些情况是不通行的。</p>

<pre><code>&gt; db.c.update({"title" : {$ne:"t2"}},{$push:{"title":"t2"}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t1", "t2", "t2" ], "type" : "suv" }
&gt; db.c.update({"name" : "toyota"},{$addToSet:{"title":"t2"}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t1", "t2", "t2" ], "type" : "suv" }
</code></pre>

<p>6.数组修改器–$pop、$pull</p>

<p>$pop从数组的头或者尾删除数组中的元素，</p>

<p>示例如下：</p>

<pre><code>{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,  "width" : 7, "length" : 15 }, "title" : [ "t1", "t2", "t3", "t4" ],"type" : "suv" }
</code></pre>

<p>从数组的尾部删除 1</p>

<pre><code>&gt; db.c.update({"name" : "toyota"},{$pop:{"title":1}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t1", "t2", "t3" ], "type" : "suv" }
</code></pre>

<p>从数组的头部 -1</p>

<pre><code>&gt; db.c.update({"name" : "toyota"},{$pop:{"title":-1}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t2", "t3" ], "type" : "suv" }
</code></pre>

<p>从数组的尾部删除 0</p>

<pre><code>&gt; db.c.update({"name" : "toyota"},{$pop:{"title":0}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t2" ], "type" : "suv" }
</code></pre>

<p>$pull从数组中删除满足条件的元素，示例如下：</p>

<pre><code>{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t1", "t2", "t2", "t3" ],"type" : "suv" }
 
&gt; db.c.update({"name" : "toyota"},{$pull:{"title":"t2"}})
&gt; db.c.find()
{ "_id" : ObjectId("5003be465af21ff428dafbe7"), "name" : "toyota", "size" : { "height" : 8,
 "width" : 7, "length" : 15 }, "title" : [ "t1", "t3" ], "type" : "suv" }
</code></pre>

<p>7.数组的定位修改器</p>

<p>在需要对数组中的值进行操作的时候，可通过位置或者定位操作符（”$”)，数组是0开始的，可以直接将下标作为键来选择元素。<br />
使用$定位操作符时，若为多个文档满足条件，则只更新第一个文档。</p>

<p>示例如下：</p>

<pre><code>{"uid":"001",comments:[{"name":"t1","size":10},{"name":"t2","size":12}]}
&gt; db.c.find({"uid":"001"})
{ "_id" : ObjectId("5003da405af21ff428dafbe8"), "uid" : "001", "comments" : [ {
"name" : "t1", "size" : 10 }, { "name" : "t2", "size" : 12 } ] }
&gt; db.c.update({"uid":"001"},{$inc:{"comments.0.size":1}})
&gt; db.c.find({"uid":"001"})
{ "_id" : ObjectId("5003da405af21ff428dafbe8"), "uid" : "001", "comments" : [ {
"name" : "t1", "size" : 11 }, { "name" : "t2", "size" : 12 } ] }
&gt; db.c.update({"comments.name":"t1"},{$set:{"comments.$.size":1}})
&gt; db.c.find({"uid":"001"})
{ "_id" : ObjectId("5003da405af21ff428dafbe8"), "uid" : "001", "comments" : [ {
"name" : "t1", "size" : 1 }, { "name" : "t2", "size" : 12 } ] }
</code></pre>

<p>8.upsert</p>

<p>upsert是一种特殊的更新。当没有符合条件的文档，就以这个条件和更新文档为基础创建一个新的文档，如果找到匹配的文档就正常的更新。
使用upsert，既可以避免竞态问题，也可以减少代码量（update的第三个参数就表示这个upsert，参数为true时）</p>

<pre><code>&gt; db.c.remove()
&gt; db.c.update({"size":11},{$inc:{"size":3}})
&gt; db.c.find()
&gt; db.c.update({"size":11},{$inc:{"size":3}},false)
&gt; db.c.find()
&gt; db.c.update({"size":11},{$inc:{"size":3}},true)
&gt; db.c.find()
{ "_id" : ObjectId("5003ded6c28f67507a6df1de"), "size" : 14 }
</code></pre>

<p>9.save函数</p>

<p>1.可以在文档不存在的时候插入，存在的时候更新，只有一个参数文档。<br />
2.要是文档含有”_id”，会调用upsert。否则，会调用插入。</p>

<pre><code>&gt; db.a.find()
{ "_id" : ObjectId("50026affdeb4fa8d154f8572"), "desc" : "hello world1!", "num": 50,
 "sname" : "jk", "type" : "1", "uid" : "20120002" }
&gt; var o = db.a.findOne()
&gt; o.num = 55
55
&gt; db.a.save(o)
&gt; db.a.find()
{ "_id" : ObjectId("50026affdeb4fa8d154f8572"), "desc" : "hello world1!", "num": 55,
 "sname" : "jk", "type" : "1", "uid" : "20120002" }
</code></pre>

<hr />

<h4 id="section-5">索引管理</h4>

<ul>
  <li>
    <p>在字段firstname升序和lastname降序上创建一个名为idx_name的联合索引</p>

    <pre><code>  db.user.ensureIndex({"firstname":1, "lastname":-1}, {"name":"idx_name"})
</code></pre>
  </li>
  <li>
    <p>在username上创建一个唯一索引</p>

    <pre><code>  db.user.ensureIndex({"username":1}, {"unique":true});
</code></pre>
  </li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">makeLaugh</span></span>

      








  


<time datetime="2015-01-04T15:56:30+08:00" pubdate data-updated="true">Jan 4<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/web/'>web</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/01/04/phpkai-fa-gui-fan/" title="Previous Post: Phpkai Fa Gui Fan">&laquo; Phpkai Fa Gui Fan</a>
      
      
    </p>
  </footer>
</article>


</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/01/04/mongodbchang-yong-cao-zuo/">mongodb常用操作</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/04/phpkai-fa-gui-fan/">Phpkai Fa Gui Fan</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/04/macxia-pei-zhi-webkai-fa-huan-jing/">Macxia Pei Zhi Webkai Fa Huan Jing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/11/shan-yong-xcode%2Cti-gao-kai-fa-xiao-lu/">善用Xcode，提高开发效率</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/11/gitjian-dan-shi-yong-cao-zuo/">git简单实用操作</a>
      </li>
    
  </ul>
</section>




<aside>
	<h3>About Bill <img src="/images/branding/avatar.png" class="left" style="padding-right: 10px;" /></h3>
	<p>
		I'm Bill Patrianakos. I created <a href="https://writeapp.me">Write.app</a>, founded  <a href="https://chooseclever.com">Clever Web Design</a>, and  work as a web developer in Chicago.
		<br />
		<a class="button" href="">Related Stuff <i class="icon-circle-arrow-down"></i></a>
	</p>
</aside>

  
</aside>



  <section>
    <h1>评论</h1>
    <div id="comments" aria-live="polite"><!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"smellbamboo"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END --></div>
  </section>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - makeLaugh -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  














</body>
</html>
